name: Deploy Server to GCP VM (Simple)

on:
  push:
    branches:
      - main
    paths:
      - 'server/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create deploy script
      run: |
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸ“ Setting up project directory..."
        cd $HOME
        
        # Clone or update repository
        if [ ! -d "pbf-server" ]; then
          echo "ðŸ“¥ Cloning repository..."
          git clone https://github.com/$1.git pbf-server
        else
          echo "ðŸ“¥ Updating existing repository..."
          cd pbf-server
          git fetch origin
          git reset --hard origin/main
          cd $HOME
        fi
        
        cd pbf-server/server
        
        # Install dependencies
        if ! command -v node >/dev/null 2>&1; then
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
        fi
        
        if ! command -v pnpm >/dev/null 2>&1; then
          sudo npm install -g pnpm
        fi
        
        if ! command -v pm2 >/dev/null 2>&1; then
          sudo npm install -g pm2
        fi
        
        echo "ðŸ“¦ Installing project dependencies..."
        pnpm install
        
        # Create PM2 config
        cat > ecosystem.config.js << 'EOFPM2'
module.exports = {
  apps: [{
    name: "pbf-server",
    script: "./app.js",
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: "1G",
    env: {
      NODE_ENV: "production",
      PORT: 3000
    }
  }]
};
EOFPM2
        
        mkdir -p logs
        
        echo "ðŸ›‘ Stopping existing processes..."
        pm2 stop pbf-server 2>/dev/null || true
        pm2 delete pbf-server 2>/dev/null || true
        
        echo "ðŸš€ Starting application..."
        pm2 start ecosystem.config.js
        pm2 save
        
        echo "âœ… Deployment completed!"
        pm2 list
        EOF
        
        chmod +x deploy.sh

    - name: Create environment file
      run: |
        cat > .env << EOF
   

    - name: Setup SSH and Deploy
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.GCP_VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.GCP_VM_IP }} >> ~/.ssh/known_hosts
        
        # Copy files to server
        scp deploy.sh ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_IP }}:~/
        scp .env ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_IP }}:~/
        
        # Execute deploy script
        ssh ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_IP }} "bash ~/deploy.sh ${{ github.repository }}"
        
        # Move .env to correct location
        ssh ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_IP }} "mv ~/.env ~/pbf-server/server/"
        
        # Restart with env
        ssh ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_IP }} "cd ~/pbf-server/server && pm2 restart pbf-server"